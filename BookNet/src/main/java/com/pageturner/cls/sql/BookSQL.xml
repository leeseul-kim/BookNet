<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
					"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 
	이 파일은 출판사, 책, 추천도서에 관한 데이터베이스 작업을 할 질의명령을 담은 파일이다.
	작성자	: 박기윤
	작성일	: 2020.06.28
	버전	: v.1.0
 -->
<mapper namespace="bookSQL">
	<select id="pbCk" parameterType="bVO" resultType="int">
		SELECT
		    COUNT(*) cnt
		FROM
		    publishtab
		WHERE
		    publish = #{publisher}
	</select>
	
	<select id="bookCk" parameterType="bVO" resultType="int">
		SELECT
		    COUNT(*) cnt
		FROM
		    booktab
		WHERE
		    isbn = #{isbn}
	</select>
	
	<insert id="addPb" parameterType="bVO">
		<selectKey keyProperty="publish_no" resultType="int" order="BEFORE">
			SELECT
				NVL(MAX(publish_no) + 1, 1)
			FROM
				publishtab
		</selectKey>
		INSERT INTO
			publishtab(publish_no, publish)
		VALUES(
			${publish_no}, #{publisher}
		)
	</insert>
	
	<insert id="addBook" parameterType="bVO">
		<selectKey keyProperty="bno,publish_no"
					resultType="bVO" order="BEFORE">
			SELECT
				NVL(MAX(bno) + 1, 1) bno,
				publishtab.publish_no
			FROM
				booktab, publishtab
			WHERE
				publishtab.publish = #{publisher}
			GROUP BY
				publishtab.publish_no
		</selectKey>
		INSERT INTO
			booktab(bno, bname, genre, smallimg, largeimg,
					writer, trans, isbn, publish_no)
		VALUES(
			${bno}, #{title}, ${categoryId}, #{smallimg},
			#{largeimg}, #{author}, #{translator},
			#{isbn}, ${publish_no}
		)
	</insert>
	
	<insert id="addPeriod" parameterType="rcmdVO">
		<selectKey keyProperty="map"
					resultType="map" order="BEFORE">
			SELECT
				TO_CHAR(NVL(MAX(recomdate_no) + 1, 1)) recomdate_no,
				TO_CHAR(NVL(MAX(recomdate_start) + 7, '2020-06-30'), 'yyyy-MM-dd') recomdate_start,
				TO_CHAR(NVL(MAX(recomdate_end) + 7, '2020-07-06'), 'yyyy-MM-dd') recomdate_end
			FROM
				recomdatetab
		</selectKey>
		INSERT INTO
			recomdatetab(recomdate_no, recomdate_start, recomdate_end)
		VALUES(
			#{map.RECOMDATE_NO,jdbcType=INTEGER}, #{map.RECOMDATE_START,jdbcType=DATE}, #{map.RECOMDATE_END,jdbcType=DATE}
		)
	</insert>
	
	<insert id="addRcmdBook" parameterType="rcmdVO">
		<selectKey keyProperty="recom_no"
					resultType="rcmdVO" order="BEFORE">
			SELECT
				NVL(MAX(recom_no) + 1, 1) recom_no
			FROM
				recomtab
		</selectKey>
		INSERT INTO
			recomtab(recom_no, bno, recomdate_no, classify, cat_id)
		VALUES(
			${recom_no}, ${bno}, ${recomdate_no}, #{classify}, ${cat_id}
		)
	</insert>
	
	<select id="seldRcmdList" resultType="bVO">
		SELECT
			bname title, largeimg, gname, writer author,
			publish publisher, cat_id, classify
		FROM
			booktab bt, genretab gt, publishtab pt,
			recomdatetab rdt, recomtab rt
		WHERE
			sysdate BETWEEN recomdate_start AND recomdate_end
			AND rt.recomdate_no = rdt.recomdate_no
			AND bt.bno = rt.bno
			AND gt.genre = bt.genre
			AND pt.publish_no = bt.publish_no
	</select>
	
	<select id="selGenreList" resultType="int">
		SELECT
			genre
		FROM
			genretab
	</select>
</mapper>